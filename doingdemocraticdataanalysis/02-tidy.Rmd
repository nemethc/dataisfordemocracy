# Tidy Data

## Tidy Data, or Why you should clean your room

## Learning the Language of Tidy Data^[Adapted from Hadley Wickham's paper on [Tidy Data](https://vita.had.co.nz/papers/tidy-data.pdf)]

If you have ever typed a formula in excel, congrats! You are a programmer. Embrace it! If you haven't, you will soon, and then you will be a programmer too. Excel is the world's largest and most underrated programming language. Now, you just have to embrace thinking programmaticlly-- tidy. It's like grammar. There are rules so these sentances (hopefully) make sense to you, the reader. Similarily, by following common conventions of tidy data analysis, others will be able to "read" your analysis like you are reading this sentance. And also, like grammar, you can break the rules-- but it helps to know them first. 

Here are a couple definitions that will help as you move through this text. Don't worry about memorizing them, as I will refer back to these definitions frequently. 

* Fields
    * A field is a fancy name for a column. From here on out, every calculation, manipulation, formula, you name it, will be on a column. I want you to forget that you could ever modify a lone cell in Excel. No more formulas in cells. No more typing in values to a cell. Certainly no more writing over data in a cell. Democratic data analysis depends on formulas that work on entire fields. Everything you would need to do to a single cell in Excel can-- and should!-- be done to an entire column. This will be immensly valuable, as you will hopefully see while working through this material. 

* Variables
    * A variable is something in your data that can change. That's it! Variables become very important when looking at how to structure your data. 
  
* Observations
    * Observations make up the rows of your dataset. Each observation should correspond to a specific "thing." This will make more sense later, I promise. 

* Values
    * Values are the actual data in your table. Each value belongs to 1 (one) observation and 1 (one) variable. 
  
* Table
    * A table is the grouping of all observations of a similar type. 

## Thinking in Pivot Tables-- From Wide to Long. 

Pivot tables are amazing. THey are the world's most common, most helpful, and most underrated data analysis tool. PowerBI interactive charts and graphs are just pivot tables in disguise. Understanding what is needed to make a pivot table work is the key to the wide world of data analysis. 

A pivot table groups data by field and allows the user to drag fields to the rows or columns of the pivot table. This is effective when each field is a variable (something that can change), and each row is a seperate observation of some phenomena of interest. 

In short, pivot tables depend on **tidy data**. 

Tidy data is the way your data should be organized before you begin your analysis. In tidy data, each column is a *variable*, each row is an *observation*, and each table is an *associated set of observations*. What does that mean in practice? Consider the following example. 

Below is a table^[Data was created for demonstration purposes] that shows types of retirement visits for a month at a state's Department of Retirement Services by the employee who took the visit and the visit type. 
  
```{r tables-visits, message=FALSE, warning = FALSE, echo=TRUE}
library(tidyverse)

visits <- tribble(
  ~"Employee", ~"Phone Visits", ~"Office Visits", ~"Online Visits",
  "Danielle", 6, 11, 23,
  "Ramona", 11, 5, 18,
  "Ross", 10, 10, 10 
)

knitr::kable(visits, caption = "Visits to the Dept. of Retirement Services in a given month")

```
  
Data are frequently displayed in this "wide" format. It works great for presentation, but not great for data analysis. 

The shortcomings of data in this format may become apparent when you attempt to work with the data in a pivot table. This is becuase our columns aren't truly variables. You can drag the fields from the top row to the grey box below, for columns, and the left, for rows. This becomes unmanegable quickly. 

```{r}
rpivotTable::rpivotTable(visits, width = "60%", height = "60%")
```





Let's apply our criteria of tidy data to this set:

* Variables
    * At first glance, it doensn't look like this is a problem. But think again. Is `phone visits` really a variable? Or is the real variable of interest number of visits? And are our column names actually variables too (type of visit)? 
    
Let's take another swing at setting up our table for data analysis purposes. This can be accomplished easily in R using the code below, or in Excel by loading the data with `Get and Transform` -> selecting the three "visits" columns -> right clicking -> and selecting "unpivot columns."

```{r}
#We have already loaded the "tidyverse" library so we do not have to do it again

pivot_visits <- visits %>% #we are editing the "visits" table already created by storing it in a new table pivot_visits
  pivot_longer(-Employee, names_to = "Visit Type", values_to = "Number of Visits") #using pivot_longer on every column except "employee" and setting the name of the new columns


knitr::kable(pivot_visits, caption = "Visits to the Dept. of Retirement Services in a given month")
```

Now this is a table that is much easier to analyze in an Excel pivot table or with a variety of R functions. Using data in this format, it is easy to recreate the original table for presentation, while also giving a variety of options for formatting and plotting. Use the pivot table below to recreate the original table using the tidy data. *Hint- Instead of Count, select Sum -> Number of Visits as the value field. It is far easier to work with fields when they are in a tidy format. 


```{r}
rpivotTable::rpivotTable(pivot_visits, width = "60%", height = "400px")
```


When we get to the next chapter, you will learn several alternatives to pivot tables that use the same principles, but are more reproducible. 

## Using lower level data

Let's introduce a slightly more complicated tidy data problem, using the same base data as before. 

```{r}
visits_retirements <- tribble(
  ~"Employee", ~"Phone Visits", ~"Phone Retirements", ~"Office Visits", ~"Office Retirements", ~"Online Visits", ~"Online Retirements",
  "Danielle", 6, 4, 11, 8, 23, 15,
  "Ramona", 11, 7, 5, 3, 18, 15,
  "Ross", 10, 8, 10, 7, 10, 9 
)

knitr::kable(visits_retirements, caption = "Visits to the Dept. of Retirement Services in a given month by employee and associated client retirements")
```

Hopefully you will see a similar pattern here. Now, there are three variables: Visit type, number of visits, and number of retirements. Again, this data works fine for presentation but could use tidying to ease in analysis. 

```{r}
visits_retirements %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = 'excel',
                   searching = FALSE))
```

Try to tidy this in R or Excel Get and Transform. See this footnote^[powerquery hints] or look at the code if you need a hint. 


```{r}
visits_retirements_tidy <- visits_retirements %>%
  pivot_longer(cols = -Employee, 
               names_to = c("Visit Location", "Type"), 
               names_sep = " ")

print(visits_retirements_tidy)
```
In this case, we actually pivoted too far. It will probably be more useful to have the counts of visits and retirements in their own category. Keep in mind the scope of the observation-- It is perfectly valid for each to have their own column, as it is visits and retirements per month. 

```{r}
visits_retirements_tidy2 <- visits_retirements_tidy %>% 
  pivot_wider(id_cols = c(Employee, `Visit Location`, Type), names_from = Type, values_from = value)

print(visits_retirements_tidy2)
```

From here, it is easy to do calculations based on fields, rather than cells. For example, in R or Get and Transform, you could add the following:

```{r}
visits_pct <- visits_retirements_tidy2 %>% 
  mutate(pct_retirements = Retirements / Visits)

print(visits_pct)
```


And then, one of the most useful things you can do is develop formulas by grouping of rows. For example, you may want to know the total number of visits and retirements by retiree, regardless of visit location. That can be accomplished in a pivot table. 

```{r}

```


## So how is this democratic?


## Practice problems

  